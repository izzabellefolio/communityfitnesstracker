<div class="container py-5 my-4 justify-content-center">

  <!-- Top Navigation -->

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Outer: check loading -->
  <ng-container *ngIf="!isLoading; else loading">
    
    <!-- Inner: check if user is logged in -->
    <ng-container *ngIf="user$ | async as user; else publicView">
      <div [@slideInOut]>
        <!-- Dashboard for logged-in user -->
        <div class="row g-4 justify-content-center">

         <div class="col-md-3">
          <div class="dashboard-card card-today shadow-sm h-100 text-center p-4 rounded-4">
            <i class="bi bi-clipboard-check display-4 text-success mb-3"></i>
            <h5 class="fw-bold mb-2">Today's Routine</h5>

            <ng-container *ngIf="todayRoutine; else noRoutine">
              <h6 class="mt-3 fw-semibold">{{ todayRoutine.name }}</h6>
              <p class="text-muted small">
                {{ todayRoutine.exercises.length }} exercises · {{ todayRoutine.time }}
              </p>
              <a routerLink="/routines/{{ todayRoutine.id }}" class="btn btn-success btn-sm mt-2">
                View Routine
              </a>
            </ng-container>

            <ng-template #noRoutine>
              <p class="text-muted small">No routine scheduled for today.</p>
              <a routerLink="/routines" class="btn btn-outline-success btn-sm mt-2">
                Browse Routines
              </a>
            </ng-template>
          </div>
        </div>


          <!-- Daily Challenge -->
          <div class="col-md-3">
            <div class="dashboard-card card-challenge shadow-sm h-100 text-center p-4 rounded-4 d-flex flex-column align-items-center">
              <i class="bi bi-trophy display-4 text-warning mb-3"></i>
              <h5 class="fw-bold mb-2">Daily Challenge</h5>

              <ng-container *ngIf="dailyChallenge; else noChallenge">
                <h6 class="mt-3">{{ dailyChallenge.title }}</h6>
                <p class="text-muted small">{{ dailyChallenge.description }}</p>
                <a routerLink="/challenges" class="btn btn-warning btn-sm mt-2">
                  Take Challenge
                </a>
              </ng-container>

              <ng-template #noChallenge>
                <p class="text-muted small">No challenge today. Check back tomorrow!</p>
                <a routerLink="/challenges" class="btn btn-outline-warning btn-sm mt-2">
                  Browse Challenges
                </a>
              </ng-template>
            </div>
          </div>

          <!-- User Metrics card (new) -->
          <div class="col-md-3">
            <div class="dashboard-card card-metrics shadow-sm h-100 text-center p-4 rounded-4 d-flex flex-column align-items-center">
              <i class="bi bi-person-circle display-4 text-primary mb-3"></i>
              <h5 class="fw-bold mb-2">Your Metrics</h5>

              <ng-container *ngIf="userService.userMetrics$ | async as userMetrics; else loadingMetrics">

                <div class="mt-2">
                  <div class="small text-muted">Weight</div>
                  <div class="fw-semibold">{{ userMetrics.weight }} kg</div>
                </div>

                <div class="mt-2">
                  <div class="small text-muted">Height</div>
                  <div class="fw-semibold">{{ userMetrics.height }} cm</div>
                </div>

                <div class="mt-2">
                  <div class="small text-muted">BMI</div>
                  <div class="fw-semibold">{{ userMetrics.bmi }}</div>
                </div>

                <div class="mt-2">
                  <div class="small text-muted">Metabolism</div>
                  <div class="fw-semibold text-capitalize">{{ userMetrics.metabolism }}</div>
                </div>

                <div class="mt-2">
                  <div class="small text-muted">Gender</div>
                  <div class="fw-semibold text-capitalize">{{ userMetrics.gender }}</div>
                </div>

                <button type="button" class="btn btn-outline-custom btn-sm mt-2" (click)="openEditMetrics()">
                  Edit Metrics
                </button>

              </ng-container>

              <ng-template #loadingMetrics>
                <div class="text-center py-3">
                  <div class="spinner-border spinner-border-sm text-primary"></div>
                  <div class="small text-muted mt-2">Loading metrics...</div>
                </div>
              </ng-template>
            </div>
          </div>


        </div> <!-- /.row -->

        <!-- Inline Edit Metrics Modal -->
        <div *ngIf="editModalOpen">
          <div class="modal fade show d-block" tabindex="-1" aria-modal="true" role="dialog" style="background: rgba(0,0,0,0.4);">
            <div class="modal-dialog modal-sm modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Edit Metrics</h5>
                  <button type="button" class="btn-close" aria-label="Close" (click)="closeEditMetrics()"></button>
                </div>
                <div class="modal-body">
                  <form [formGroup]="metricsForm" (ngSubmit)="saveMetrics()">
                    <div class="mb-3">
                      <label class="form-label small">Weight (kg)</label>
                      <input type="number" formControlName="weight" class="form-control" />
                      <div *ngIf="metricsForm.get('weight')?.touched && metricsForm.get('weight')?.invalid" class="text-danger small mt-1">
                        Enter a valid weight (20–500).
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label small">Height (cm)</label>
                      <input type="number" formControlName="height" class="form-control" />
                      <div *ngIf="metricsForm.get('height')?.touched && metricsForm.get('height')?.invalid" class="text-danger small mt-1">
                        Enter a valid height (100–250).
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label small">Metabolism</label>
                      <select class="form-select" formControlName="metabolism">
                        <option value="slow">Slow</option>
                        <option value="medium">Medium</option>
                        <option value="fast">Fast</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label class="form-label small">Gender</label>
                      <select class="form-select" formControlName="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                      </select>
                    </div>

                    <div *ngIf="bmi !== null" class="mb-2">
                      <div class="small text-muted">BMI</div>
                      <div class="fw-semibold">{{ bmi }}</div>
                    </div>

                    <div *ngIf="saveError" class="alert alert-danger small">{{ saveError }}</div>

                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" (click)="closeEditMetrics()" [disabled]="saveLoading">Cancel</button>
                  <button type="button" class="btn btn-primary" (click)="saveMetrics()" [disabled]="saveLoading">
                    <span *ngIf="saveLoading" class="spinner-border spinner-border-sm me-2"></span>
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </ng-container>

  </ng-container>

  <ng-template #loading>
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </ng-template>
  </div>

  <!-- Public View -->
  <ng-template #publicView>
    <div [@slideInOut]>
      <!-- Hero Section -->
      <div class="hero-section py-5 mb-5">
        <div class="hero-background"></div>
        <div class="container">
          <div class="hero-content p-5 text-center text-white rounded-5">
            <div class="mb-4 hero-icon-container">
              <div class="icon-ring">
                <i class="bi bi-activity display-3 hero-icon"></i>
              </div>
            </div>
            <h2 class="fw-bold mb-3 display-4 text-white hero-title">
              <span class="gradient-text">Level Up Your</span> Fitness Journey
            </h2>
            <p class="fs-5 mb-3 text-white hero-subtitle">
              Track workouts, build streaks, and stay motivated with a community that moves with you.
            </p>
            <p class="small opacity-85 mb-5 fs-6 text-white hero-subtext">Stronger every day — start where you are.</p>

            <a id="firstStartBtn" routerLink="/login" class="btn btn-light btn-lg px-6 py-3 rounded-pill fw-bold fs-5 shadow-sm start-btn hero-btn">
              Get Started Now
            </a>
          </div>
        </div>
      </div>
      <!-- Features Section -->
      <section class="features-section container my-5 py-5">
        <div class="text-center mb-5">
          <h3 class="fw-bold mb-2 display-6">What You Can Do</h3>
          <p class="text-muted fs-5">Everything you need to achieve your fitness goals</p>
        </div>
        <div class="row g-4">
          <div class="col-md-4 feature-card-wrapper">
            <div class="feature-card p-5 rounded-4 bg-white h-100 shadow-sm">
              <div class="feature-icon-bg mb-4">
                <i class="bi bi-clipboard-check text-success feature-icon"></i>
              </div>
              <h5 class="fw-bold mb-3">Log Your Workouts</h5>
              <p class="text-muted mb-0">Track your daily exercises, reps, sets, and progress effortlessly.</p>
            </div>
          </div>
          <div class="col-md-4 feature-card-wrapper">
            <div class="feature-card p-5 rounded-4 bg-white h-100 shadow-sm">
              <div class="feature-icon-bg mb-4">
                <i class="bi bi-fire text-danger feature-icon"></i>
              </div>
              <h5 class="fw-bold mb-3">Maintain Your Streak</h5>
              <p class="text-muted mb-0">Stay consistent and earn streak milestones for your dedication.</p>
            </div>
          </div>
          <div class="col-md-4 feature-card-wrapper">
            <div class="feature-card p-5 rounded-4 bg-white h-100 shadow-sm">
              <div class="feature-icon-bg mb-4">
                <i class="bi bi-trophy text-warning feature-icon"></i>
              </div>
              <h5 class="fw-bold mb-3">Join Challenges</h5>
              <p class="text-muted mb-0">Compete with the community and push yourself to new heights.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- App Preview Section -->
      <section class="preview-section container my-5 py-5">
        <div class="row align-items-center g-5">
          <div class="col-md-6">
            <div class="preview-content">
              <h3 class="fw-bold mb-4 display-6">Your Progress at a Glance</h3>
              <p class="text-muted fs-5 mb-3">
                A clean and user-friendly dashboard lets you easily view routines, achievements, streaks, and your overall fitness journey.
              </p>
              <p class="text-muted fs-5 mb-4">Built to motivate you every day.</p>
              <div class="d-flex gap-3">
                <div class="preview-stat">
                  <div class="stat-number">500K+</div>
                  <div class="stat-label">Active Users</div>
                </div>
                <div class="preview-stat">
                  <div class="stat-number">10M+</div>
                  <div class="stat-label">Workouts Logged</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="preview-image-wrapper rounded-4 shadow-lg overflow-hidden">
              <img
                src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=500&q=80"
                alt="Fitness Progress"
                class="img-fluid"
                loading="lazy"
                width="500"
                height="333"
              >
            </div>
          </div>
        </div>
      </section>

      <!-- Testimonials Section -->
      <section class="testimonials-section container my-5 py-5">
        <div class="text-center mb-5">
          <h3 class="fw-bold mb-2 display-6">What People Are Saying</h3>
          <p class="text-muted fs-5">Join thousands of people achieving their fitness goals</p>
        </div>
        <div class="row g-4">
          <div class="col-md-4" *ngFor="let t of testimonials">
            <div class="testimonial-card p-4 bg-white rounded-4 shadow-sm h-100">
              <div class="testimonial-stars mb-3">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
              </div>
              <p class="fst-italic text-muted mb-3">"{{ t.text }}"</p>
              <div class="testimonial-author">
                <div class="author-avatar me-2">{{ t.name.charAt(0) }}</div>
                <div>
                  <p class="fw-bold mb-0">{{ t.name }}</p>
                  <p class="small text-muted mb-0">Age {{ t.age }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </ng-template>
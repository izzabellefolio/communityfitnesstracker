<div class="challenge-container" *ngIf="!isLoading; else loadingTemplate">
  
  <!-- Points and Streak Banner -->
  <div class="stats-banner">
    <div class="stats-grid">
      <!-- Total Points -->
      <div class="stat-card points-card">
        <div class="stat-icon">ğŸ†</div>
        <div class="stat-content">
          <h3>Total Points</h3>
          <div class="stat-value">{{ totalPoints | number:'1.0-0' }}</div>
          <p class="stat-trend" *ngIf="pointsToday > 0">
            +{{ pointsToday }} today
          </p>
          <div class="progress-mini">
            <div class="progress-fill" [style.width.%]="getPointsProgress()"></div>
          </div>
          <p class="stat-subtext">Next level: {{ pointsToNextLevel }} points</p>
        </div>
        <button class="btn-points-info" (click)="showPointsInfo()">
          â„¹ï¸
        </button>
      </div>

      <!-- Current Streak -->
      <div class="stat-card streak-card" [class.high-streak]="currentStreak >= 7">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-content">
          <h3>Current Streak</h3>
          <div class="stat-value">{{ currentStreak }}</div>
          <p class="stat-subtext" *ngIf="lastActivity">
            Last activity: {{ lastActivity | date:'MMM d' }}
          </p>
          <div class="streak-badges">
            <span *ngIf="currentStreak >= 3" class="streak-badge">3+ days</span>
            <span *ngIf="currentStreak >= 7" class="streak-badge">1 week</span>
            <span *ngIf="currentStreak >= 30" class="streak-badge">1 month</span>
          </div>
        </div>
        <button class="btn-streak-info" (click)="showStreakInfo()">
          ğŸ“ˆ
        </button>
      </div>

      <!-- Challenge Stats -->
      <div class="stat-card challenge-stats">
        <div class="stat-icon">ğŸ¯</div>
        <div class="stat-content">
          <h3>Challenge Stats</h3>
          <div class="stats-grid-small">
            <div class="mini-stat">
              <div class="mini-value">{{ completedChallenges }}</div>
              <div class="mini-label">Completed</div>
            </div>
            <div class="mini-stat">
              <div class="mini-value">{{ successRate }}%</div>
              <div class="mini-label">Success Rate</div>
            </div>
            <div class="mini-stat">
              <div class="mini-value">{{ longestStreak }}</div>
              <div class="mini-label">Best Streak</div>
            </div>
          </div>
          <p class="stat-subtext">
            Level {{ userLevel }} â€¢ {{ getRankTitle() }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Change Notification -->
  <div *ngIf="showDateChangeNotification" class="date-change-notification">
    <div class="notification-content">
      <span>ğŸ“… New day detected! Loading today's challenge...</span>
      <button class="btn-notification" (click)="dismissNotification()">
        Dismiss
      </button>
    </div>
  </div>
  
  <!-- Header Section -->
  <div class="challenge-header">
    <div class="header-content">
      <h1>Daily Fitness Challenges</h1>
      <p class="subtitle">Complete daily exercises to build consistency and improve fitness</p>
      
      <div class="date-display">
        <div class="current-date">
          <span class="day-name">{{ dayName }}</span>
          <span class="date-full">{{ currentDate | date:'fullDate' }}</span>
        </div>
        <div class="date-actions">
          <button class="btn-date-action" (click)="checkDateManually()" title="Check for date change">
            ğŸ”„ Check Date
          </button>
          <button class="btn-date-action" (click)="refreshChallenge()" title="Refresh challenge">
            ğŸ”„ Refresh Challenge
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Challenge Card -->
  <div class="todays-challenge" *ngIf="todaysChallenge">
    <div class="challenge-card featured">
      <div class="challenge-badge">Today's Challenge</div>
      
      <div class="challenge-header">
        <div>
          <h2>{{ todaysChallenge.title }}</h2>
          <div class="challenge-meta">
            <span class="difficulty-badge" [class]="todaysChallenge.difficulty.toLowerCase()">
              {{ todaysChallenge.difficulty }}
            </span>
            <span class="category-badge">{{ todaysChallenge.category }}</span>
            <span class="points-value">ğŸ¯ {{ getChallengePoints() }} points</span>
          </div>
          <p class="challenge-description">{{ todaysChallenge.description }}</p>
        </div>
        
        <div class="challenge-completion" [class.completed]="todaysChallenge.completed">
          <div class="completion-circle" [style.--progress]="completionPercentage">
            <span>{{ completionPercentage }}%</span>
          </div>
          <div class="completion-status">
            {{ todaysChallenge.completed ? 'âœ… Completed' : 'ğŸ”„ In Progress' }}
          </div>
        </div>
      </div>

      <!-- Exercises List -->
      <div class="exercises-section">
        <div class="section-header">
          <h3>Today's Exercises</h3>
          <div class="section-info">
            <span class="points-info">Each exercise: {{ getExercisePoints() }} points</span>
            <button class="btn-complete-all" 
                    *ngIf="!todaysChallenge.completed"
                    (click)="completeAllExercises()">
              âœ… Complete All
            </button>
          </div>
        </div>
        
        <div class="exercises-list">
          <div *ngFor="let exercise of todaysChallenge.exercises" 
               class="exercise-item" 
               [class.completed]="exercise.completed">
            
            <div class="exercise-checkbox">
              <input type="checkbox" 
                     [id]="'ex-' + exercise.id"
                     [checked]="exercise.completed"
                     (change)="toggleExercise(exercise.id)">
              <label [for]="'ex-' + exercise.id"></label>
            </div>
            
            <div class="exercise-content">
              <div class="exercise-header">
                <div class="exercise-title">
                  <h4>{{ exercise.name }}</h4>
                  <div class="exercise-points">
                    <span class="points-badge">+{{ getExercisePoints() }} pts</span>
                  </div>
                </div>
                <span class="muscle-group">{{ exercise.muscleGroup }}</span>
              </div>
              
              <p class="exercise-description">{{ exercise.description }}</p>
              
              <div class="exercise-specs">
                <div class="spec">
                  <strong>Sets:</strong> {{ exercise.sets }}
                </div>
                <div class="spec">
                  <strong>Reps:</strong> {{ exercise.reps }}
                </div>
                <div class="spec" *ngIf="exercise.restTime">
                  <strong>Rest:</strong> {{ exercise.restTime }}s
                </div>
                <div class="spec" *ngIf="exercise.equipment">
                  <strong>Equipment:</strong> {{ exercise.equipment }}
                </div>
              </div>
            </div>
            
            <div class="exercise-actions">
              <div class="exercise-status">
                <span *ngIf="exercise.completed" class="completed-badge">
                  âœ“ +{{ getExercisePoints() }} pts
                </span>
                <button *ngIf="!exercise.completed" 
                        class="btn-mark-complete" 
                        (click)="markExerciseComplete(exercise.id)">
                  Mark Complete (+{{ getExercisePoints() }} pts)
                </button>
              </div>
              <div class="exercise-progress">
                <div class="reps-tracker" *ngIf="!exercise.completed">
                  <button class="btn-rep" (click)="updateExerciseReps(exercise.id, -1)">-</button>
                  <span class="current-reps">{{ getCompletedReps(exercise) }}/{{ exercise.reps }}</span>
                  <button class="btn-rep" (click)="updateExerciseReps(exercise.id, 1)">+</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress & Points Summary -->
      <div class="challenge-summary">
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Progress</span>
            <div class="progress-bar-large">
              <div class="progress-fill" [style.width.%]="completionPercentage"></div>
            </div>
            <span class="summary-value">{{ completedExercises }}/{{ totalExercises }} exercises</span>
          </div>
          
          <div class="summary-item">
            <span class="summary-label">Points Earned</span>
            <div class="points-display">
              <span class="points-value">{{ getEarnedPoints() }}</span>
              <span class="points-max">/{{ getTotalPoints() }} pts</span>
            </div>
            <span class="summary-value">{{ getPointsPercentage() }}% of total</span>
          </div>
          
          <div class="summary-item">
            <span class="summary-label">Time Estimate</span>
            <div class="time-estimate">
              <span class="time-value">{{ estimateTime() }} min</span>
            </div>
            <span class="summary-value">Approx. completion time</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="challenge-actions">
        <button class="btn btn-secondary" (click)="viewChallengeHistory()">
          ğŸ“‹ View History
        </button>
        <button *ngIf="!todaysChallenge.completed" 
                class="btn btn-primary" 
                (click)="completeChallenge()"
                [disabled]="!allExercisesCompleted">
          ğŸ Complete Challenge (+{{ getChallengeBonus() }} bonus)
        </button>
        <button class="btn btn-share" (click)="shareProgress()">
          ğŸ“¤ Share Progress
        </button>
      </div>
    </div>
  </div>

  <!-- Streak & Points Info Panel -->
  <div *ngIf="showInfoPanel" class="info-panel">
    <div class="panel-header">
      <h3>Points & Streak System</h3>
      <button class="btn-close" (click)="closeInfoPanel()">Ã—</button>
    </div>
    <div class="panel-content">
      <div class="points-system">
        <h4>How Points Work:</h4>
        <ul>
          <li>âœ… Each completed exercise: <strong>10 points</strong></li>
          <li>ğŸ¯ Complete daily challenge: <strong>50 bonus points</strong></li>
          <li>ğŸ”¥ 7-day streak bonus: <strong>100 points</strong></li>
          <li>ğŸ† 30-day streak bonus: <strong>500 points</strong></li>
          <li>ğŸŒŸ Perfect week (7/7 days): <strong>200 points</strong></li>
        </ul>
      </div>
      <div class="streak-system">
        <h4>How Streak Works:</h4>
        <ul>
          <li>ğŸ”¥ Streak continues if you complete at least one exercise daily</li>
          <li>â° Streak resets after 24 hours of inactivity</li>
          <li>ğŸ“Š Track your longest streak in stats</li>
          <li>ğŸ… Earn badges at 3, 7, 30, and 100 days</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading your daily challenge...</p>
  </div>
</ng-template>
<div class="container mt-4">
  <h2 class="mb-4 text-center">Progress Tracking</h2>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading your progress...</p>
  </div>

  <!-- Stats Cards -->
  <ng-container *ngIf="!loading">
    <ng-container *ngIf="stats$ | async as stats">
      <div class="row mb-4 justify-content-center">
        <div class="col-12 col-sm-6 col-md-3 mb-3">
          <app-stats-card
            title="Total Workouts"
            [value]="stats.totalWorkouts"
            subtitle="Sessions completed"
            icon="ðŸ’ª"
            gradient="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)">
          </app-stats-card>
        </div>
        <div class="col-12 col-sm-6 col-md-3 mb-3">
          <app-stats-card
            title="Total Reps"
            [value]="stats.totalReps"
            subtitle="All exercises combined"
            icon="ðŸ“ˆ"
            gradient="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)">
          </app-stats-card>
        </div>
        <div class="col-12 col-sm-6 col-md-3 mb-3">
          <app-stats-card
            title="Calories Burned"
            [value]="Math.round(stats.caloriesBurned)"
            subtitle="Total calories"
            icon="ðŸ‹ðŸ½"
            gradient="linear-gradient(135deg, #fa709a 0%, #fee140 100%)">
          </app-stats-card>
        </div>
        <div class="col-12 col-sm-6 col-md-3 mb-3">
          <app-stats-card
            title="Current Streak"
            [value]="stats.streak"
            subtitle="Days in a row"
            icon="ðŸ”¥"
            gradient="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)">
          </app-stats-card>
        </div>
      </div>

      <!-- Last Workout Info -->
      <div class="alert alert-info text-center mb-4">
        <strong>Last Workout:</strong>
        {{ stats.lastWorkoutDate ? (stats.lastWorkoutDate | date:'fullDate') : 'No workouts yet' }}
      </div>

      <!-- Charts Section -->
      <div class="row g-4 justify-content-center">

        <!-- Weekly Progress Card -->
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">

              <!-- Header -->
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
                <h6 class="mb-2 mb-md-0 fw-bold">Weekly Progress</h6>
                <div class="d-flex align-items-center">
                  <div class="small text-muted me-3">{{ rangeDays }}-day overview</div>
                  <div class="range-toggle">
                    <button class="btn btn-sm btn-outline-secondary" [class.active]="rangeDays===7" (click)="changeRange(7)">7d</button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" [class.active]="rangeDays===14" (click)="changeRange(14)">14d</button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" [class.active]="rangeDays===30" (click)="changeRange(30)">30d</button>
                  </div>
                </div>
              </div>

              <!-- Charts Grid -->
              <div class="row g-4 justify-content-center">
                <div class="col-12 col-md-6">
                  <div class="chart-container">
                    <h6 class="small text-muted text-center mb-2">Calories ({{ rangeDays }}d)</h6>
                    <canvas #caloriesChart></canvas>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="chart-container">
                    <h6 class="small text-muted text-center mb-2">Workouts / Reps ({{ rangeDays }}d)</h6>
                    <canvas #repsChart></canvas>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="chart-container">
                    <h6 class="small text-muted text-center mb-2">Intensity ({{ rangeDays }}d)</h6>
                    <canvas #intensityChart></canvas>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="chart-container">
                    <h6 class="small text-muted text-center mb-2">Weight / BMI</h6>
                    <canvas #weightChart></canvas>
                  </div>
                </div>
              </div>

              <!-- Improvement / Consistency -->
              <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mt-4">
                <div class="d-flex align-items-center mb-3 mb-md-0">
                  <div class="me-3">
                    <div class="badge rounded-pill"
                         [ngClass]="{
                           'bg-success': improvementStatus === 'improving',
                           'bg-warning': improvementStatus === 'maintaining',
                           'bg-danger': improvementStatus === 'regressing'
                         }"
                         style="color:#fff;">
                      {{ improvementStatus | titlecase }}
                    </div>
                  </div>
                  <div class="ms-2">
                    <div class="small text-muted">Weekly consistency: <strong>{{ getWeeklyConsistency() }}%</strong></div>
                    <div class="small text-muted">Avg calories: <strong>{{ getWeeklyAverage() }}</strong></div>
                  </div>
                </div>

                <!-- Linear improvement meter -->
                <div class="text-center text-md-end" style="min-width:220px;">
                  <div class="small text-muted mb-1">Improvement</div>
                  <div class="meter-bar">
                    <div class="meter-fill"
                         [style.width.%]="improvementScore"
                         [style.background]="improvementStatus==='improving' ? '#2ecc71' : (improvementStatus==='maintaining' ? '#f6c23e' : '#e74a3b')">
                    </div>
                  </div>
                  <div class="small text-muted mt-1">{{ improvementStatus | titlecase }} â€” {{ improvementScore | number:'1.0-0' }}%</div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Recent Workouts -->
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold">Recent Workouts</h6>
                <div class="small text-muted">{{ recentWorkouts.length }} shown</div>
              </div>

              <div *ngIf="recentWorkouts.length === 0" class="text-center text-muted py-3">
                <p>No recent workouts found</p>
              </div>

              <ul class="list-group list-group-flush" *ngIf="recentWorkouts.length > 0">
                <li class="list-group-item" *ngFor="let w of recentWorkouts">
                  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <div>
                      <div class="fw-semibold">{{ w.routineName }}</div>
                      <div class="small text-muted">{{ formatDate(w.date) }}</div>
                      <div class="small mt-2">
                        <span class="me-2">Intensity:
                          <span [style.color]="getIntensityColor(w.intensity || 5)">{{ w.intensity ?? 'â€”' }}</span>
                        </span>
                        <span class="me-2">Exercises: {{ w.exercises?.length || 0 }}</span>
                        <span>Reps: {{ w.totalReps || 0 }}</span>
                      </div>

                      <ul class="mt-2 mb-0 ps-3">
                        <li *ngFor="let ex of w.exercises" class="small text-muted">
                          <span class="fw-medium">{{ ex.name }}</span>
                          <span class="ms-2">â€¢</span>
                          <span class="ms-2" *ngIf="ex.duration"> {{ ex.duration }} min</span>
                          <span class="ms-2" *ngIf="ex.sets && ex.reps"> {{ ex.sets }}Ã—{{ ex.reps }}</span>
                          <span class="ms-2">â€” {{ ex.calories ?? '-' }} cal</span>
                        </li>
                      </ul>
                    </div>

                    <div class="text-end small mt-2 mt-md-0">
                      <div class="text-muted">Duration</div>
                      <div class="fw-semibold">{{ w.duration ?? 0 }} min</div>
                      <div class="text-muted mt-1">Calories</div>
                      <div class="fw-semibold">{{ Math.round(w.totalCalories ?? w.totalCalories ?? w.calories ?? 0) }} cal</div>
                    </div>
                  </div>
                </li>
              </ul>

            </div>
          </div>
        </div>

      </div>
    </ng-container>
  </ng-container>
</div>
